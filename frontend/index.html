<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CareForAll - Support Medical Campaigns</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <div class="nav-brand">
          <h1>CareForAll</h1>
        </div>
        <div class="nav-links">
          <a href="index.html">Home</a>
          <a href="create-campaign.html" id="createCampaignLink"
            >Create Campaign</a
          >
          <a href="history.html">My Donations</a>
          <a href="admin.html" id="adminLink" style="display: none">Admin</a>
          <a href="login.html" id="loginLink">Login</a>
          <a href="#" id="logoutLink" style="display: none">Logout</a>
        </div>
      </div>
    </nav>

    <main class="container">
      <section class="hero">
        <h2>Support Medical Campaigns That Matter</h2>
        <p>
          Join thousands of donors making a difference in medical fundraising
        </p>
      </section>

      <section class="campaigns-section">
        <div class="section-header">
          <h3>Active Campaigns</h3>
          <button id="refreshBtn" class="btn-secondary">Refresh</button>
        </div>

        <div id="loadingState" class="loading">Loading campaigns...</div>
        <div id="errorState" class="error-message" style="display: none"></div>
        <div id="campaignsGrid" class="campaigns-grid"></div>
      </section>
    </main>

    <footer class="footer">
      <div class="container">
        <p>&copy; 2025 CareForAll - Built for API Avengers Hackathon</p>
      </div>
    </footer>

    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script>
      // Initialize homepage
      async function loadCampaigns() {
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const campaignsGrid = document.getElementById('campaignsGrid');

        try {
          loadingState.style.display = 'block';
          errorState.style.display = 'none';
          campaignsGrid.innerHTML = '';

          const campaigns = await api.get('/api/campaigns');

          loadingState.style.display = 'none';

          if (campaigns.length === 0) {
            campaignsGrid.innerHTML =
              '<p class="no-campaigns">No active campaigns yet. Be the first to create one!</p>';
            return;
          }

          // Load totals for each campaign
          for (const campaign of campaigns) {
            const card = createCampaignCard(campaign);
            campaignsGrid.appendChild(card);

            // Fetch totals asynchronously
            fetchCampaignTotal(campaign._id, card);
          }
        } catch (error) {
          console.error('Error loading campaigns:', error);
          loadingState.style.display = 'none';
          errorState.style.display = 'block';
          errorState.textContent =
            'Failed to load campaigns. Please try again.';
        }
      }

      function createCampaignCard(campaign) {
        const card = document.createElement('div');
        card.className = 'campaign-card';
        card.innerHTML = `
                <div class="campaign-header">
                    <h4>${escapeHtml(campaign.title)}</h4>
                    <span class="campaign-status status-${campaign.status}">${
          campaign.status
        }</span>
                </div>
                <p class="campaign-description">${escapeHtml(
                  campaign.description
                )}</p>
                <div class="campaign-goal">
                    <strong>Goal:</strong> $${campaign.goalAmount.toLocaleString()}
                </div>
                <div class="campaign-progress">
                    <div class="progress-info">
                        <span class="raised-amount" data-campaign-id="${
                          campaign._id
                        }">Loading...</span>
                        <span class="goal-amount">of $${campaign.goalAmount.toLocaleString()}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" data-campaign-id="${
                          campaign._id
                        }" style="width: 0%"></div>
                    </div>
                </div>
                <div class="campaign-footer">
                    <span class="campaign-date">Ends: ${new Date(
                      campaign.endDate
                    ).toLocaleDateString()}</span>
                    <a href="campaign-detail.html?id=${
                      campaign._id
                    }" class="btn-primary">Donate Now</a>
                </div>
            `;
        return card;
      }

      async function fetchCampaignTotal(campaignId, card) {
        try {
          const totals = await api.get(`/api/totals/${campaignId}`);
          const raisedAmount = totals.totalAmount || 0;

          const raisedElement = card.querySelector(
            `.raised-amount[data-campaign-id="${campaignId}"]`
          );
          const progressBar = card.querySelector(
            `.progress-fill[data-campaign-id="${campaignId}"]`
          );

          if (raisedElement) {
            raisedElement.textContent = `$${raisedAmount.toLocaleString()} raised`;
          }

          if (progressBar) {
            const goalAmount = parseFloat(
              card
                .querySelector('.campaign-goal')
                .textContent.match(/[\d,]+/)[0]
                .replace(/,/g, '')
            );
            const percentage = Math.min((raisedAmount / goalAmount) * 100, 100);
            progressBar.style.width = `${percentage}%`;
          }
        } catch (error) {
          console.error(
            `Error fetching totals for campaign ${campaignId}:`,
            error
          );
          const raisedElement = card.querySelector(
            `.raised-amount[data-campaign-id="${campaignId}"]`
          );
          if (raisedElement) {
            raisedElement.textContent = '$0 raised';
          }
        }
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Event listeners
      document
        .getElementById('refreshBtn')
        .addEventListener('click', loadCampaigns);

      // Load campaigns on page load
      document.addEventListener('DOMContentLoaded', () => {
        initAuth();
        loadCampaigns();
      });
    </script>
  </body>
</html>
