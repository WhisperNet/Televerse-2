x-shared-env: &shared-env
  MONGODB_URI: ${MONGODB_URI}
  RABBITMQ_URI: ${RABBITMQ_URI}
  JWT_SECRET: ${JWT_SECRET}
  WEBHOOK_SECRET: ${WEBHOOK_SECRET}
  RABBITMQ_EXCHANGE: ${RABBITMQ_EXCHANGE}

services:
  mongo:
    image: mongo:6.0
    container_name: careforall-mongo
    command: ['mongod', '--replSet', 'rs0', '--bind_ip_all']
    healthcheck:
      test:
        ['CMD', 'mongosh', '--quiet', '--eval', 'db.runCommand({ ping: 1 })']
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - mongo-data:/data/db
    networks:
      - careforall-net
    ports:
      - '27017:27017'

  mongo-init-replica:
    image: mongo:6.0
    container_name: careforall-mongo-init
    depends_on:
      mongo:
        condition: service_healthy
    entrypoint:
      [
        'sh',
        '-c',
        'mongosh --host mongo --eval ''rs.initiate({_id:"rs0",members:[{_id:0,host:"mongo:27017"}]})'' && sleep 5',
      ]
    restart: 'no'
    networks:
      - careforall-net

  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: careforall-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123
    ports:
      - '5672:5672'
      - '15672:15672'
    healthcheck:
      test: ['CMD', 'rabbitmq-diagnostics', 'check_port_connectivity']
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - careforall-net

  prometheus:
    image: prom/prometheus:v2.52.0
    container_name: careforall-prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
    ports:
      - '9090:9090'
    networks:
      - careforall-net

  grafana:
    image: grafana/grafana:11.1.0
    container_name: careforall-grafana
    depends_on:
      - prometheus
    ports:
      - '3000:3000'
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin123
      GF_AUTH_ANONYMOUS_ENABLED: 'true'
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    networks:
      - careforall-net

  nginx:
    image: nginx:1.27-alpine
    container_name: careforall-nginx
    ports:
      - '8080:80'
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - identity-service
      - campaign-service
    networks:
      - careforall-net

  identity-service:
    image: node:18-alpine
    container_name: careforall-identity
    working_dir: /usr/src/app
    command: ['sh', '-c', 'npm install && node src/index.js']
    volumes:
      - ./services/identity-service:/usr/src/app
      - ./shared:/usr/src/app/shared
      - /usr/src/app/node_modules
    environment:
      <<: *shared-env
      SERVICE_NAME: identity-service
      PORT: 3001
    ports:
      - '3001:3001'
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - careforall-net

  campaign-service:
    image: node:18-alpine
    container_name: careforall-campaign
    working_dir: /usr/src/app
    command: ['sh', '-c', 'npm install && node src/index.js']
    volumes:
      - ./services/campaign-service:/usr/src/app
      - ./shared:/usr/src/app/shared
      - /usr/src/app/node_modules
    environment:
      <<: *shared-env
      SERVICE_NAME: campaign-service
      PORT: 3002
    ports:
      - '3002:3002'
    depends_on:
      mongo:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - careforall-net

  pledge-service:
    image: node:18-alpine
    container_name: careforall-pledge
    working_dir: /usr/src/app
    command: ['sh', '-c', 'npm install && node src/index.js']
    volumes:
      - ./services/pledge-service:/usr/src/app
      - ./shared:/usr/src/app/shared
      - /usr/src/app/node_modules
    environment:
      <<: *shared-env
      SERVICE_NAME: pledge-service
      PORT: 3003
    ports:
      - '3003:3003'
    depends_on:
      mongo:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - careforall-net

  payment-service:
    image: node:18-alpine
    container_name: careforall-payment
    working_dir: /usr/src/app
    command: ['sh', '-c', 'npm install && node src/index.js']
    volumes:
      - ./services/payment-service:/usr/src/app
      - ./shared:/usr/src/app/shared
      - /usr/src/app/node_modules
    environment:
      <<: *shared-env
      SERVICE_NAME: payment-service
      PORT: 3004
      WEBHOOK_URL: http://payment-service:3004/payments/webhooks
    ports:
      - '3004:3004'
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - careforall-net

  totals-service:
    image: node:18-alpine
    container_name: careforall-totals
    working_dir: /usr/src/app
    command: ['sh', '-c', 'npm install && node src/index.js']
    volumes:
      - ./services/totals-service:/usr/src/app
      - ./shared:/usr/src/app/shared
      - /usr/src/app/node_modules
    environment:
      <<: *shared-env
      SERVICE_NAME: totals-service
      PORT: 3005
    ports:
      - '3005:3005'
    depends_on:
      mongo:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - careforall-net

  frontend:
    image: alpine:3.20
    container_name: careforall-frontend
    command: ['tail', '-f', '/dev/null']
    networks:
      - careforall-net

networks:
  careforall-net:
    driver: bridge

volumes:
  mongo-data:
  rabbitmq-data:
  prometheus-data:
  grafana-data:
